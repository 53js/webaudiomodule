<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Wasabi Container v2</title>
		<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webaudio-controls.js"></script>
	</head>
	<body>
		<main className="ContainerV2">
			<audio
				id="player"
				src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/BasketCaseGreendayriffDI.mp3"
				controls
				loop
				crossOrigin="anonymous"
			>
			</audio>
			<div id="mount"></div>
		</main>
		<script>
			/**
			 * Patches global AudioNode for WebAudioPlugin sdk compatibility
			 * Should be avoided in the next release
			 **/
			/*AudioNode.prototype._connect = AudioNode.prototype.connect;
			var that = this;
			AudioNode.prototype.connect = function (that) {
				var args = Array.prototype.slice.call(arguments);
				if (args[0]._isCompositeAudioNode && !args[2] && !args[1]) {
					args[0] = args[0]._input;
					args[1] = that._output;
				}
				else if (args[0]._isCompositeAudioNode) args[0] = args[2];
				this._connect.apply(this, args);
			};*/

			const player = document.querySelector('#player');
			const mount = document.querySelector('#mount');

			const audioContext = new AudioContext();
			const mediaElementSource = audioContext.createMediaElementSource(player);

			const connectPlugin = (audioNode) => {
				// mediaElementSource.connect(audioNode._input); // instead of patching AudioNode, use composite input and output
				// audioNode._output.connect(audioContext.destination);
				mediaElementSource.connect(audioNode);
				audioNode.connect(audioContext.destination);
			};

			const mountPlugin = (domNode) => {
				mount.innerHtml = '';
				mount.appendChild(domNode);
			};

			/**
			 * webaudioplugin loader sdk
			 * Very simple for the moment
			 **/
			const load = async (url) => {
				const plugin = await import(url);
				const pluginAudioNode = await plugin.getAudioNode(audioContext);
				pluginAudioNode.setParam('status', 'disable');
				connectPlugin(pluginAudioNode);
				const pluginDomNode = await plugin.getDomNode(pluginAudioNode);
				mountPlugin(pluginDomNode);
			}

			(async () => {
				await load('./pingpongdelay/index.js');
				//await load('./pingpongdelay/index.js'); // should be loaded once !
			})()

		</script>
	</body>
</html>
